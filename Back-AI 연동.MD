-----

# **ë°±ì—”ë“œ-RAG AI ì„œë²„ ì—°ë™ ê°œë°œ ê°€ì´ë“œ**

ì´ ë¬¸ì„œëŠ” Python ê¸°ë°˜ì˜ ë°±ì—”ë“œ(`DataTide_back`)ì™€ RAG AI ëª¨ë¸ ì„œë²„(`DataTide_ai`)ë¥¼ ë¶„ë¦¬í•˜ì—¬ APIë¡œ ì—°ë™í•˜ëŠ” ì „ì²´ ê³¼ì •ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

### **ìµœì¢… ì•„í‚¤í…ì²˜**

ì‚¬ìš©ìì˜ ìš”ì²­ì€ ë°±ì—”ë“œ ì„œë²„ë¥¼ í†µí•´ AI ì„œë²„ë¡œ ì „ë‹¬ë˜ë©°, AI ì„œë²„ëŠ” RAG ëª¨ë¸ì„ í†µí•´ ìƒì„±ëœ ë‹µë³€ì„ ë‹¤ì‹œ ë°±ì—”ë“œë¥¼ ê±°ì³ ì‚¬ìš©ìì—ê²Œ ë°˜í™˜í•©ë‹ˆë‹¤.

**íë¦„**: `ì‚¬ìš©ì` â†” `ë°±ì—”ë“œ ì„œë²„ (í¬íŠ¸ 8000)` â†” `AI ì„œë²„ (í¬íŠ¸ 8001)` â†” `RAG ëª¨ë¸`

-----

## **1ë‹¨ê³„: RAG AI ì„œë²„ êµ¬ì¶• (`DataTide_ai`)**

AI ëª¨ë¸ì˜ ì¶”ë¡ ì„ ì „ë‹´í•˜ê³ , ì´ë¥¼ APIë¡œ ë…¸ì¶œí•˜ëŠ” ì„œë²„ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

### **1. í”„ë¡œì íŠ¸ ì¤€ë¹„**

  - **í´ë” êµ¬ì¡°**
    ```
    DataTide_ai/
    â””â”€â”€ RAG_AI/
        â”œâ”€â”€ data/
        â”‚   â””â”€â”€ sample_document.txt
        â”œâ”€â”€ .env
        â”œâ”€â”€ main.py
        â””â”€â”€ rag_model.py
    ```
  - **í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜**
    ```bash
    pip install fastapi "uvicorn[standard]" python-dotenv langchain langchain-openai langchain-community faiss-cpu sentence-transformers
    ```
  - **í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (`.env` íŒŒì¼)**
    `sk-...` ë¶€ë¶„ì— ì‹¤ì œ OpenAI API í‚¤ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
    ```
    OPENAI_API_KEY="sk-..."
    ```

### **2. RAG ëª¨ë¸ ë¡œì§ ì‘ì„± (`rag_model.py`)**

LangChainì„ ì‚¬ìš©í•˜ì—¬ RAG íŒŒì´í”„ë¼ì¸ì˜ í•µì‹¬ ë¡œì§ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

```python
# DataTide_ai/RAG_AI/rag_model.py

import os
from dotenv import load_dotenv
from langchain_community.document_loaders import DirectoryLoader, TextLoader
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_community.embeddings import HuggingFaceEmbeddings
from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from langchain.schema.runnable import RunnablePassthrough
from langchain.schema.output_parser import StrOutputParser

def setup_rag_chain():
    """RAG íŒŒì´í”„ë¼ì¸ì„ ì„¤ì •í•˜ê³  ì²´ì¸ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    print(">> RAG ì²´ì¸ ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    load_dotenv()
    
    # 1. ë¬¸ì„œ ë¡œë“œ
    loader = DirectoryLoader(path="./data", glob="**/*.txt", loader_cls=TextLoader, loader_kwargs={'encoding': 'utf-8'})
    documents = loader.load()
    if not documents:
        raise ValueError("'./data' í´ë”ì— ì°¸ì¡°í•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.")

    # 2. ë¬¸ì„œ ë¶„í• 
    text_splitter = RecursiveCharacterTextSplitter(chunk_size=500, chunk_overlap=50)
    split_docs = text_splitter.split_documents(documents)

    # 3. ì„ë² ë”© ë° ë²¡í„° DB ì €ì¥
    embeddings = HuggingFaceEmbeddings(
        model_name="jhgan/ko-srobert-multitask",
        model_kwargs={'device': 'cpu'},
        encode_kwargs={'normalize_embeddings': True}
    )
    vector_store = FAISS.from_documents(split_docs, embeddings)

    # 4. ê²€ìƒ‰ê¸°(Retriever) ìƒì„±
    retriever = vector_store.as_retriever()

    # 5. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì •ì˜
    template = """
    ë‹¹ì‹ ì€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì•„ë˜ì˜ 'context' ì •ë³´ë§Œì„ ì‚¬ìš©í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”.
    [Context]: {context}
    [Question]: {question}
    """
    prompt = ChatPromptTemplate.from_template(template)

    # 6. LLM ëª¨ë¸ ì •ì˜
    llm = ChatOpenAI(model_name="gpt-3.5-turbo", temperature=0.1)

    # 7. RAG ì²´ì¸ êµ¬ì„±
    rag_chain = (
        {"context": retriever, "question": RunnablePassthrough()}
        | prompt
        | llm
        | StrOutputParser()
    )
    print(">> RAG ì²´ì¸ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ…")
    return rag_chain

def get_rag_response(chain, query: str) -> str:
    """ìƒì„±ëœ RAG ì²´ì¸ì„ ì‚¬ìš©í•˜ì—¬ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    print(f">> RAG ëª¨ë¸ í˜¸ì¶œ: '{query}'")
    response = chain.invoke(query)
    print(">> RAG ëª¨ë¸ ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ.")
    return response
```

### **3. API ì„œë²„ ì‘ì„± (`main.py`)**

FastAPIë¥¼ ì‚¬ìš©í•˜ì—¬ `/rag-query` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìƒì„±í•˜ê³  `rag_model.py`ì˜ ë¡œì§ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

```python
# DataTide_ai/RAG_AI/main.py

from fastapi import FastAPI
from pydantic import BaseModel
from rag_model import setup_rag_chain, get_rag_response

app = FastAPI()

class QueryRequest(BaseModel):
    question: str

# ì„œë²„ ì‹œì‘ ì‹œ RAG ì²´ì¸ì„ ë¯¸ë¦¬ ë¡œë“œí•©ë‹ˆë‹¤.
try:
    rag_chain = setup_rag_chain()
except Exception as e:
    print(f"ğŸš¨ RAG ì²´ì¸ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    rag_chain = None

@app.post("/rag-query")
async def query_rag(request: QueryRequest):
    """ì‚¬ìš©ì ì§ˆë¬¸ì„ ë°›ì•„ RAG ëª¨ë¸ì˜ ë‹µë³€ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    if rag_chain is None:
        return {"error": "RAG ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}
    
    answer = get_rag_response(rag_chain, request.question)
    return {"answer": answer}
```

-----

## **2ë‹¨ê³„: ë°±ì—”ë“œ ì„œë²„ êµ¬ì¶• (`DataTide_back`)**

ì‚¬ìš©ì ìš”ì²­ì„ ë°›ì•„ AI ì„œë²„ì™€ í†µì‹ í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

### **1. í”„ë¡œì íŠ¸ ì¤€ë¹„**

  - **í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜**
    ```bash
    pip install fastapi "uvicorn[standard]" httpx
    ```

### **2. AI ì„œë²„ í˜¸ì¶œ ì„œë¹„ìŠ¤ ì‘ì„± (`services/rag_service.py`)**

`httpx`ë¥¼ ì´ìš©í•´ AI ì„œë²„ì˜ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

```python
# DataTide_back/services/rag_service.py

import httpx

# RAG AI ì„œë²„ì˜ API ì£¼ì†Œ
RAG_API_URL = "http://127.0.0.1:8001/rag-query"

async def get_answer_from_rag(question: str) -> str:
    """HTTP í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•´ RAG AI ì„œë²„ì— ì§ˆë¬¸ì„ ë³´ë‚´ê³  ë‹µë³€ì„ ë°›ì•„ì˜µë‹ˆë‹¤."""
    async with httpx.AsyncClient() as client:
        try:
            response = await client.post(RAG_API_URL, json={"question": question}, timeout=30.0)
            response.raise_for_status() # 200ë²ˆëŒ€ ìƒíƒœ ì½”ë“œê°€ ì•„ë‹ˆë©´ ì˜ˆì™¸ ë°œìƒ
            data = response.json()
            return data.get("answer", "ë‹µë³€ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        except httpx.RequestError as e:
            print(f"RAG API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return "AI ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ê±°ë‚˜ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤."
```

### **3. ì‚¬ìš©ì API ë¼ìš°í„° ì‘ì„± (`routers/rag_router.py`)**

ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë  `/rag/ask` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì •ì˜í•˜ê³  ìœ„ì—ì„œ ë§Œë“  ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

```python
# DataTide_back/routers/rag_router.py

from fastapi import APIRouter
from pydantic import BaseModel
from services.rag_service import get_answer_from_rag

router = APIRouter()

class QueryRequest(BaseModel):
    question: str

@router.post("/ask")
async def ask_question(request: QueryRequest):
    answer = await get_answer_from_rag(request.question)
    return {"question": request.question, "answer": answer}
```

### **4. ë©”ì¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ë¼ìš°í„° ë“±ë¡ (`main.py`)**

```python
# DataTide_back/main.py

from fastapi import FastAPI
from routers import rag_router # ë‹¤ë¥¸ ë¼ìš°í„°ë“¤ë„ ì´ê³³ì—ì„œ import

app = FastAPI()

# ë‹¤ë¥¸ ë¼ìš°í„° ë“±ë¡
# app.include_router(...)

# RAG ë¼ìš°í„° ë“±ë¡
app.include_router(rag_router.router, prefix="/rag", tags=["RAG"])
```

-----

## **3ë‹¨ê³„: ì‹œìŠ¤í…œ ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸**

### **1. ì„œë²„ ì‹¤í–‰**

ë‘ ê°œì˜ í„°ë¯¸ë„ì„ ì—´ê³  ê°ê°ì˜ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

  - **í„°ë¯¸ë„ 1: AI ì„œë²„ ì‹¤í–‰**

    ```bash
    # DataTide_ai/RAG_AI í´ë”ë¡œ ì´ë™
    cd path/to/DataTide_ai/RAG_AI
    # ê°€ìƒí™˜ê²½ í™œì„±í™”
    .\venv\Scripts\activate
    # ì„œë²„ ì‹œì‘ (8001 í¬íŠ¸)
    uvicorn main:app --reload --port 8001
    ```

  - **í„°ë¯¸ë„ 2: ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰**

    ```bash
    # DataTide_back í´ë”ë¡œ ì´ë™
    cd path/to/DataTide_back
    # ê°€ìƒí™˜ê²½ í™œì„±í™”
    .\venv\Scripts\activate
    # ì„œë²„ ì‹œì‘ (8000 í¬íŠ¸)
    uvicorn main:app --reload
    ```

### **2. ì—°ë™ í…ŒìŠ¤íŠ¸**

1.  ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ë°±ì—”ë“œ ì„œë²„ì˜ API ë¬¸ì„œ `http://127.0.0.1:8000/docs` ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.
2.  `/rag/ask` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì•„ í¼ì¹˜ê³  \*\*"Try it out"\*\*ì„ í´ë¦­í•©ë‹ˆë‹¤.
3.  **Request body**ì— ì§ˆë¬¸ì„ JSON í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•©ë‹ˆë‹¤. (ì˜ˆ: `{"question": "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?"}`)
4.  **"Execute"** ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
5.  **"Server response"** ì„¹ì…˜ì—ì„œ AI ì„œë²„ë¡œë¶€í„° ì˜¨ ë‹µë³€ì´ í¬í•¨ëœ ìµœì¢… ì‘ë‹µì„ í™•ì¸í•©ë‹ˆë‹¤.

ì´ ê³¼ì •ì„ í†µí•´ ë‘ ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì—°ë™ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
